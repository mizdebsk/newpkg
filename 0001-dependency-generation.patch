From 2e7cba052c4558aa5f6102b3c771ca0d22eaab0f Mon Sep 17 00:00:00 2001
From: rpm-build <rpm-build>
Date: Fri, 7 Mar 2014 17:19:12 +0100
Subject: [PATCH] dependency generation

Signed-off-by: rpm-build <rpm-build>
---
 common-build.xml                                               |  7 +++----
 .../apache/lucene/dependencies/GetMavenDependenciesTask.java   | 10 ++++++----
 2 files changed, 9 insertions(+), 8 deletions(-)

diff --git a/common-build.xml b/common-build.xml
index 98dd678..446a954 100644
--- a/common-build.xml
+++ b/common-build.xml
@@ -1540,10 +1540,9 @@ ${ant.project.name}.test.dependencies=${test.classpath.list}
 
   <property name="maven.dependencies.filters.file" location="${common.build.dir}/maven.dependencies.filters.properties"/>
 
-  <target name="-get-maven-dependencies" depends="compile-tools,load-custom-tasks">
-    <ant dir="${common.dir}/.." target="-append-all-modules-dependencies-properties" inheritall="false"/>
+  <target name="-get-maven-dependencies" depends="compile-tools,load-custom-tasks,-append-module-dependencies-properties">
     <get-maven-dependencies-macro
-        dir="${common.dir}/.."
+        dir="."
         centralized.versions.file="${common.dir}/ivy-versions.properties"
         module.dependencies.properties.file="${module.dependencies.properties.file}"
         maven.dependencies.filters.file="${maven.dependencies.filters.file}"/>
@@ -1563,7 +1562,7 @@ ${ant.project.name}.test.dependencies=${test.classpath.list}
     </copy>
   </target>
 
-  <target name="-filter-pom-templates" depends="-get-maven-dependencies">
+  <target name="filter-pom-templates" depends="-get-maven-dependencies">
     <mkdir dir="${filtered.pom.templates.dir}"/>
     <copy todir="${common.dir}/build/poms" overwrite="true" encoding="UTF-8" filtering="on">
       <fileset dir="${common.dir}/../dev-tools/maven"/>
diff --git a/tools/src/java/org/apache/lucene/dependencies/GetMavenDependenciesTask.java b/tools/src/java/org/apache/lucene/dependencies/GetMavenDependenciesTask.java
index b89448c..be99de5 100644
--- a/tools/src/java/org/apache/lucene/dependencies/GetMavenDependenciesTask.java
+++ b/tools/src/java/org/apache/lucene/dependencies/GetMavenDependenciesTask.java
@@ -73,18 +73,18 @@ import javax.xml.xpath.XPathFactory;
  */
 public class GetMavenDependenciesTask extends Task {
   private static final Pattern PROPERTY_PREFIX_FROM_IVY_XML_FILE_PATTERN = Pattern.compile
-      ("[/\\\\](lucene|solr)[/\\\\](?:(?:contrib|(analysis)|(example))[/\\\\])?([^/\\\\]+)[/\\\\]ivy\\.xml");
+      ("[/\\\\](solr|lucene)[-0-9.]*[/\\\\](?:(?:contrib|(analysis)|(example))[/\\\\])?([^/\\\\]+)[/\\\\]ivy\\.xml");
   private static final Pattern COORDINATE_KEY_PATTERN = Pattern.compile("/([^/]+)/([^/]+)");
   private static final Pattern MODULE_DEPENDENCIES_COORDINATE_KEY_PATTERN
       = Pattern.compile("(.*?)(\\.test)?\\.dependencies");
   // lucene/build/core/classes/java
   private static final Pattern COMPILATION_OUTPUT_DIRECTORY_PATTERN 
-      = Pattern.compile("(lucene|solr)/build/(?:contrib/)?(.*)/classes/(?:java|test)");
+      = Pattern.compile("(solr|lucene)[-0-9.]*/build/(?:contrib/)?(.*)/classes/(?:java|test)");
   private static final Pattern PROPERTY_REFERENCE_PATTERN = Pattern.compile("\\$\\{([^}]+)\\}");
   private static final String UNWANTED_INTERNAL_DEPENDENCIES
       = "/(?:test-)?lib/|test-framework/classes/java|/test-files|/resources";
   private static final Pattern SHARED_EXTERNAL_DEPENDENCIES_PATTERN
-      = Pattern.compile("((?:solr|lucene)/(?!test-framework).*)/((?:test-)?)lib/");
+      = Pattern.compile("((?:lucene|solr)[-0-9.]*/(?!test-framework).*)/((?:test-)?)lib/");
 
   private static final String DEPENDENCY_MANAGEMENT_PROPERTY = "lucene.solr.dependency.management";
   private static final String IVY_USER_DIR_PROPERTY = "ivy.default.ivy.user.dir";
@@ -482,6 +482,7 @@ public class GetMavenDependenciesTask extends Task {
   (String groupId, String artifactId, String version) {
     SortedSet<String> transitiveDependencies = new TreeSet<String>();
     //                                      E.g. ~/.ivy2/cache/xerces/xercesImpl/ivy-2.9.1.xml
+    /*
     File ivyXmlFile = new File(new File(new File(ivyCacheDir, groupId), artifactId), "ivy-" + version + ".xml");
     if ( ! ivyXmlFile.exists()) {
       throw new BuildException("File not found: " + ivyXmlFile.getPath());
@@ -502,6 +502,7 @@ public class GetMavenDependenciesTask extends Task {
                               + groupId + ':' + artifactId + ':' + version + " from "
                               + ivyXmlFile.getAbsolutePath(), e);
     }
+    */
     return transitiveDependencies;
   }
 
@@ -526,7 +528,7 @@ public class GetMavenDependenciesTask extends Task {
         // Lucene analysis modules' build dirs do not include hyphens, but Solr contribs' build dirs do
         String origModuleDir = antProjectName.replace("analyzers-", "analysis/");
         Pattern unwantedInternalDependencies = Pattern.compile
-            ("(?:lucene/build/|solr/build/(?:contrib/)?)" + origModuleDir + "|" + UNWANTED_INTERNAL_DEPENDENCIES);
+            ("(?:lucene[-0-9.]*/build/|solr[-0-9.]*/build/(?:contrib/)?)" + origModuleDir + "|" + UNWANTED_INTERNAL_DEPENDENCIES);
         SortedSet<String> sortedDeps = new TreeSet<String>();
         for (String dependency : value.split(",")) {
           matcher = SHARED_EXTERNAL_DEPENDENCIES_PATTERN.matcher(dependency);
-- 
1.8.5.3

